<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censys Data Summarizer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Censys Data Summarizer</h1>
            <p>Upload host data and generate AI-powered summaries</p>
        </header>

        <div class="upload-section">
            <div class="upload-card">
                <h2>Upload Host Data</h2>
                <div class="upload-controls">
                    <input type="file" id="fileInput" accept=".json" />
                    <select id="summarizerSelect">
                        <option value="groq">Groq (Llama 3.1 8B) - Cloud Optimized</option>
                        <option value="huggingface">HuggingFace (BART) - Local Only</option>
                    </select>
                    <button id="summarizeBtn" onclick="handleSummarize()">
                        Generate Summaries
                    </button>
                </div>
                <div id="uploadStatus" class="status-message"></div>
            </div>

            <div class="sample-data">
                <button onclick="loadSampleData()" class="secondary-btn">
                    Load hosts_dataset
                </button>
            </div>
        </div>

        <div id="loadingSpinner" class="loading-spinner hidden">
            <div class="spinner"></div>
            <p>Generating summaries...</p>
        </div>

        <div id="resultsSection" class="results-section hidden">
            <h2>Summary Results</h2>
            <div class="results-header">
                <span id="summarizerUsed" class="badge"></span>
                <span id="hostCount" class="badge"></span>
            </div>
            <div id="summariesContainer" class="summaries-container"></div>
        </div>
    </div>

    <script>
        // Use local backend for development, proxy for production
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8000' 
            : '/api';
        let currentData = null;

        async function handleSummarize() {
            const fileInput = document.getElementById('fileInput');
            const summarizer = document.getElementById('summarizerSelect').value;
            const statusDiv = document.getElementById('uploadStatus');

            if (!fileInput.files.length && !currentData) {
                statusDiv.textContent = 'Please select a file or load sample data';
                statusDiv.className = 'status-message error';
                return;
            }

            showLoading(true);
            statusDiv.textContent = '';

            try {
                let response;
                
                if (fileInput.files.length > 0) {
                    // Upload file
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('summarizer', summarizer);

                    response = await fetch(`${API_BASE}/upload_dataset?summarizer=${summarizer}`, {
                        method: 'POST',
                        body: formData
                    });
                } else if (currentData) {
                    // Use loaded sample data
                    response = await fetch(`${API_BASE}/batch_summarize`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            hosts: currentData,
                            summarizer: summarizer
                        })
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate summaries');
                }

                const result = await response.json();
                displayResults(result);
                statusDiv.textContent = 'Summaries generated successfully!';
                statusDiv.className = 'status-message success';
            } catch (error) {
                console.error('Error:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'status-message error';
            } finally {
                showLoading(false);
            }
        }

        async function loadSampleData() {
            const statusDiv = document.getElementById('uploadStatus');
            try {
                // Real Censys dataset for demonstration
                currentData = [
                    {
                        "ip": "168.196.241.227",
                        "location": {
                            "city": "New York City",
                            "country": "United States",
                            "country_code": "US",
                            "coordinates": {
                                "latitude": 40.71427,
                                "longitude": -74.00597
                            }
                        },
                        "autonomous_system": {
                            "asn": 263744,
                            "name": "Udasha S.A.",
                            "country_code": "HN"
                        },
                        "services": [
                            {
                                "port": 11558,
                                "protocol": "SSH",
                                "banner": "SSH-2.0-OpenSSH_8.7",
                                "software": [
                                    {
                                        "product": "openssh",
                                        "vendor": "openbsd",
                                        "version": "8.7"
                                    }
                                ],
                                "vulnerabilities": [
                                    {
                                        "cve_id": "CVE-2023-38408",
                                        "severity": "critical",
                                        "cvss_score": 9.8,
                                        "description": "Known exploited vulnerability"
                                    },
                                    {
                                        "cve_id": "CVE-2024-6387",
                                        "severity": "high",
                                        "cvss_score": 8.1,
                                        "description": "Known exploited vulnerability"
                                    }
                                ]
                            }
                        ],
                        "threat_intelligence": {
                            "security_labels": ["REMOTE_ACCESS"],
                            "risk_level": "high"
                        }
                    },
                    {
                        "ip": "1.92.135.168",
                        "location": {
                            "city": "Beijing",
                            "country": "China",
                            "country_code": "CN",
                            "coordinates": {
                                "latitude": 39.9075,
                                "longitude": 116.39723
                            }
                        },
                        "autonomous_system": {
                            "asn": 55990,
                            "name": "HWCSNET Huawei Cloud Service data center",
                            "country_code": "CN"
                        },
                        "dns": {
                            "hostname": "ecs-1-92-135-168.compute.hwclouds-dns.com"
                        },
                        "services": [
                            {
                                "port": 22,
                                "protocol": "SSH",
                                "banner": "SSH-2.0-OpenSSH_7.4",
                                "software": [
                                    {
                                        "product": "openssh",
                                        "vendor": "openbsd",
                                        "version": "7.4"
                                    }
                                ],
                                "vulnerabilities": [
                                    {
                                        "cve_id": "CVE-2023-38408",
                                        "severity": "critical",
                                        "cvss_score": 9.8
                                    },
                                    {
                                        "cve_id": "CVE-2018-15473",
                                        "severity": "medium",
                                        "cvss_score": 5.3
                                    }
                                ]
                            },
                            {
                                "port": 8074,
                                "protocol": "HTTP",
                                "banner": "HTTP/1.1 404 Not Found",
                                "malware_detected": {
                                    "name": "Cobalt Strike",
                                    "type": "c2_server",
                                    "confidence": 0.75,
                                    "threat_actors": ["FIN7", "APT41", "Cobalt Group"]
                                }
                            },
                            {
                                "port": 8082,
                                "protocol": "HTTP",
                                "banner": "HTTP/1.1 401 Unauthorized",
                                "authentication_required": true
                            }
                        ],
                        "threat_intelligence": {
                            "security_labels": ["REMOTE_ACCESS"],
                            "malware_families": ["Cobalt Strike"],
                            "risk_level": "critical"
                        }
                    },
                    {
                        "ip": "1.94.62.205",
                        "location": {
                            "city": "Shanghai",
                            "country": "China",
                            "country_code": "CN",
                            "coordinates": {
                                "latitude": 31.22222,
                                "longitude": 121.45806
                            }
                        },
                        "autonomous_system": {
                            "asn": 55990,
                            "name": "HWCSNET Huawei Cloud Service data center",
                            "country_code": "CN"
                        },
                        "dns": {
                            "hostname": "ecs-1-94-62-205.compute.hwclouds-dns.com"
                        },
                        "operating_system": {
                            "vendor": "canonical",
                            "product": "linux"
                        },
                        "services": [
                            {
                                "port": 21,
                                "protocol": "FTP",
                                "banner": "220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------",
                                "tls_enabled": true,
                                "certificate": {
                                    "fingerprint_sha256": "44d514fa03d2266b47b53927fe01d5ed6974e3ec988f3d060e6d4dd10a552766",
                                    "subject": "CN=1.94.62.205, O=BT-PANEL",
                                    "issuer": "CN=1.94.62.205, O=BT-PANEL",
                                    "self_signed": true
                                }
                            },
                            {
                                "port": 22,
                                "protocol": "SSH",
                                "banner": "SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.10",
                                "software": [
                                    {
                                        "product": "openssh",
                                        "vendor": "openbsd",
                                        "version": "8.9p1"
                                    }
                                ],
                                "vulnerabilities": [
                                    {
                                        "cve_id": "CVE-2023-38408",
                                        "severity": "critical",
                                        "cvss_score": 9.8
                                    },
                                    {
                                        "cve_id": "CVE-2024-6387",
                                        "severity": "high",
                                        "cvss_score": 8.1
                                    }
                                ]
                            },
                            {
                                "port": 80,
                                "protocol": "HTTP",
                                "banner": "HTTP/1.1 200 OK",
                                "software": [
                                    {
                                        "product": "nginx",
                                        "vendor": "f5"
                                    }
                                ],
                                "response_details": {
                                    "status_code": 200,
                                    "title": "404 Not Found"
                                }
                            },
                            {
                                "port": 888,
                                "protocol": "HTTP",
                                "banner": "HTTP/1.1 403 Forbidden",
                                "software": [
                                    {
                                        "product": "nginx",
                                        "vendor": "f5"
                                    }
                                ],
                                "response_details": {
                                    "status_code": 403,
                                    "title": "403 Forbidden"
                                }
                            },
                            {
                                "port": 3306,
                                "protocol": "MYSQL",
                                "error_message": "Host '167.94.145.97' is not allowed to connect to this MySQL server",
                                "software": [
                                    {
                                        "product": "mysql",
                                        "vendor": "oracle"
                                    }
                                ],
                                "access_restricted": true
                            },
                            {
                                "port": 8011,
                                "protocol": "HTTP",
                                "banner": "HTTP/1.1 200",
                                "response_details": {
                                    "status_code": 200,
                                    "title": "Java Chains",
                                    "content_language": "zh-CN"
                                }
                            },
                            {
                                "port": 37035,
                                "protocol": "HTTP",
                                "banner": "HTTP/1.1 404 Not Found",
                                "tls_enabled": true,
                                "certificate": {
                                    "fingerprint_sha256": "921875de7ea0a4e8345872b4d9735270fb11b45a47ec0a8d8acc5f5d119908cb",
                                    "subject": "CN=1.94.62.205, O=1.94.62.205",
                                    "issuer": "CN=ÂÆùÂ°îÈù¢Êùø, O=ÂÆùÂ°îÈù¢Êùø",
                                    "subject_alt_names": ["1.94.62.205", "192.168.14.115"]
                                },
                                "software": [
                                    {
                                        "product": "nginx",
                                        "vendor": "f5"
                                    }
                                ]
                            }
                        ],
                        "threat_intelligence": {
                            "security_labels": ["REMOTE_ACCESS"],
                            "risk_level": "high"
                        }
                    }
                ];
                
                // Clear file input
                document.getElementById('fileInput').value = '';
                
                statusDiv.textContent = 'hosts_dataset.json loaded! Click "Generate Summaries" to continue.';
                statusDiv.className = 'status-message success';
            } catch (error) {
                statusDiv.textContent = 'Failed to load sample data';
                statusDiv.className = 'status-message error';
            }
        }

        function formatSummary(summary) {
            // Convert markdown-style formatting to HTML
            let formatted = summary
                // Convert **bold** to <strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convert bullet points (- or *) to proper list items
                .replace(/^[\s]*[-*]\s+(.+)$/gm, '<li>$1</li>')
                // Convert sections that start with **Header:** to proper headers
                .replace(/^\*\*(.*?):\*\*/gm, '<div class="summary-section"><strong>$1:</strong></div>')
                // Add line breaks for better formatting
                .replace(/\n/g, '<br>')
                // Clean up multiple line breaks
                .replace(/(<br>\s*){3,}/g, '<br><br>');
            
            // Wrap bullet points in ul tags
            if (formatted.includes('<li>')) {
                formatted = formatted.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
                // Clean up nested ul tags
                formatted = formatted.replace(/<\/ul>\s*<ul>/g, '');
            }
            
            // Wrap in a div for proper styling
            return `<div class="formatted-summary">${formatted}</div>`;
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const summariesContainer = document.getElementById('summariesContainer');
            const summarizerUsed = document.getElementById('summarizerUsed');
            const hostCount = document.getElementById('hostCount');

            // Update header
            summarizerUsed.textContent = `Summarizer: ${data.summarizer_used}`;
            hostCount.textContent = `${data.summaries.length} hosts`;

            // Clear previous results
            summariesContainer.innerHTML = '';

            // Display each summary
            data.summaries.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                
                const hostInfo = item.original_data;
                const hostname = hostInfo.hostname || hostInfo.ip || 'Unknown Host';
                const serviceCount = hostInfo.services ? hostInfo.services.length : 0;
                
                card.innerHTML = `
                    <div class="summary-header">
                        <h3>${hostname}</h3>
                        <span class="host-ip">${hostInfo.ip || 'N/A'}</span>
                    </div>
                    <div class="summary-content">
                        ${formatSummary(item.summary)}
                    </div>
                    <div class="summary-footer">
                        <span class="service-count">${serviceCount} services</span>
                        <button onclick="toggleDetails(${index})" class="details-btn">
                            View Details
                        </button>
                    </div>
                    <div id="details-${index}" class="details-section hidden">
                        <pre>${JSON.stringify(hostInfo, null, 2)}</pre>
                    </div>
                `;
                
                summariesContainer.appendChild(card);
            });

            resultsSection.classList.remove('hidden');
        }

        function toggleDetails(index) {
            const detailsDiv = document.getElementById(`details-${index}`);
            detailsDiv.classList.toggle('hidden');
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        // Check API health on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                if (data.status === 'ok') {
                    console.log('API is healthy');
                }
            } catch (error) {
                console.error('API health check failed:', error);
                document.getElementById('uploadStatus').textContent = 
                    'Warning: Cannot connect to API. Make sure the backend is running on port 8000.';
                document.getElementById('uploadStatus').className = 'status-message error';
            }
        });
    </script>
</body>
</html>
